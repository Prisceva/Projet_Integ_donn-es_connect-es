<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<title>PROJET API</title>
	</head>
	<body>

		<p>test final </p>
	
		<select id="dep">
		</select>
		
		<SELECT name="handicap" id="handicap"> 
		<OPTION VALUE="visuel">Visuel</OPTION> 
		<OPTION VALUE="cognitif">Cognitif/Intellectuel</OPTION> 
		<OPTION VALUE="auditif">Auditif</OPTION> 
		<OPTION VALUE="moteur">Moteur</OPTION> 
		<OPTION VALUE="autiste">Autiste</OPTION> 
		<OPTION VALUE="sante">Santé</OPTION>
		<OPTION VALUE="apprentissage">Apprentissage</OPTION>
		<OPTION VALUE="multiple">Multiple</OPTION>
		</SELECT>
		
		<button type="button" onclick="retrouverVarDep()">rechercher</button>
		
		<h1>MDPH DANS VOTRE REGION </h1>	<!-- Le temps de faire le visuel --!>	
    	<table id = "tab_MDPH">
    	</table>
    
    	<h1>ASSOS </h1> 					<!-- Le temps de faire le visuel --!>
    	<table id="tab_asso">
		</table>
	
	
		
	</body>
	<script>

	function retrouverVarDep(){
	
	console.log(document.getElementById("handicap").value);
	console.log(document.getElementById("dep").value);
	
    var dep= document.getElementById("dep").value;
    var handicap = document.getElementById("handicap").value;

     // Fleur met tout le code ici le renomage + fonction fetch suivie du "récupéré Assos : "
	var handicap_asso=""
	var handicap_ulis=""

	if (handicap =="visuel") {
		handicap_asso="handicap visuel";
		handicap_ulis="TFV : troubles de la fonction visuelle";
	}; 
	
	if (handicap == "cognitif / intellectuel") {
		handicap_asso="troubles cognitifs / déficience intellectuelle";
		handicap_ulis="TFC : troubles des fonctions cognitives ou mentales";
	};

	if (handicap == "auditif") {
		handicap_asso="handicap auditif";
		handicap_ulis="TFA : troubles de la fonction auditive";
	} ;

	if (handicap == "moteur") {
		handicap_asso="handicap moteur";
		handicap_ulis="TFM : troubles des fonctions motrices";
	};

	if (handicap == "autisme") {
		handicap_asso="troubles du développement (autisme)";
		handicap_ulis="TED : troubles envahissants du développement (dont l'autisme)";
	};

	if (handicap == "santé") {
		handicap_asso="troubles de la santé";
		handicap_ulis="";
	};

	if (handicap == "apprentissages") {
		handicap_asso="troubles des apprentissages";
		handicap_ulis="troubles spécifiques du langage et des apprentissages";
	};

	if (handicap == "multiple") {
		handicap_asso="tous types de handicaps";
		handicap_ulis="TMA : troubles multiples associés";
	}; 

	if (handicap== "") {
		console.log("pas de trouble")
	};
	
	
	//API ULIS
	var result_ULIS;
	var region = "Occitanie" 
	fetch('https://api.opendata.onisep.fr/api/1.0/dataset/57e13d4faa63e/search?size=1000&facet.region=Occitanie')
	  .then(function(response) {
	    response.json()
		.then(function(data) {
	    console.log('ok'); 
	result_ULIS=data;
	
	var nom_ULIS = new Array;
	var adresse_ULIS = new Array;
	var commune_ULIS = new Array;
	var CodePostal_ULIS = new Array;
	
		//Récupère le résultat 
	for (i in result_ULIS){
		if (result_ULIS.results[i]["type_handicap_principal"] == handicap_ulis && result_ULIS.results[i]["departement"] == dep){
		nom_ULIS.push(result_ULIS.results[i]["nom"]);
		adresse_ULIS.push(result_ULIS.results[i]["adresse"]);
		commune_ULIS.push(result_ULIS.results[i]["commune"]);
		CodePostal_ULIS.push(result_ULIS.results[i]["cp"]);
		
		}
	};
	
	// Création du tableau ULIS 
	var tableau = "";
	var titre = "<table> <tr> <th>Nom</th> <th>Adresse</th> <th>Code Postal</th> <th>Commune</th> </tr>";
	tableau += titre;
		    
	for (i in nom_ULIS){ 
		var ligne = "<tr> <td>"+nom_ULIS[i]+"</td> <td>"+adresse_ULIS[i]+"</td> <td>"+CodePostal_ULIS[i]+"</td> <td>"+commune_ULIS[i]+"</td> </tr>";
		tableau += ligne; 
	}
	tableau += "</table>";
	
	// Ajout dans le HTML 
	var tableau_ULIS = document.getElementById("tableau_ULIS");
	tableau_ULIS.innerHTML=tableau; 
	
	
	  })})
	result_ULIS;



	// Api Assos  
	var result_Assos ;
		fetch('https://api.opendata.onisep.fr/api/1.0/dataset/57e1376b0f7fb/search?size=100')
		  .then(function(response) {
			response.json()
			.then(function(data) {
			console.log('Request successful'); 
				result_Assos=data;
				
				  // Récupérer Assos :
				var nom_asso= new Array;
				var commune_asso= new Array;
				var lien_asso= new Array;
				var text_asso="";
				text_asso = text_asso + "<tr><th>Nom</th><th>Commune</th><th>Site web</th></tr>";
				
				for (i = 0; i < result_Assos.results.length; i++) {
					if (result_Assos.results[i]["departement"] ==dep && result_Assos.results[i]["handicap_principal"] ==handicap_asso) {
						nom_asso.push(result_Assos.results[i]["nom"]);
						commune_asso.push(result_Assos.results[i]["commune"]);
						lien_asso.push(result_Assos.results[i]["lien_site_onisepfr"]);
						text_asso=text_asso+ "<tr>"+"<td>"+result_Assos.results[i]["nom"]+"</td>" + "<td>"+result_Assos.results[i]["commune"]+"</td>" +"<td>"+result_Assos.results[i]["lien_site_onisepfr"]+"</td>" +"</tr>";
					}
				};
				var associations = document.getElementById("tab_asso");
				associations.innerHTML=text_asso;			
		  })})


    //API MDPH
	var result_MDPH;
	fetch('https://api.opendata.onisep.fr/api/1.0/dataset/57e13aa4a3cee/search?size=300')
	  .then(function(response) {
	    response.json()
		.then(function(data) {
	    console.log('Request successful');
		    result_MDPH=data;
		    var nom= new Array;
		    var adresse= new Array;
		    var commune= new Array;
		    var cp= new Array;
		    var lien= new Array;
		    
		    for (i=0;i<result_MDPH.results.length;i++){
			    if (result_MDPH.results[i]["departement"] == dep) {
				    nom.push(result_MDPH.results[i]["nom"]);
				    adresse.push(result_MDPH.results[i]["adresse"]);
				    commune.push(result_MDPH.results[i]["commune"]);
				    cp.push(result_MDPH.results[i]["cp"]);
				    lien.push(result_MDPH.results[i]["lien_site_onisepfr"])
			    }
		    };
		    
		    var text="";
		    // On défini les en tetes :
		    text = text + "<tr><th>Nom</th><th>Adresse</th><th>Code Postal</th><th>Commune</th><th>Site web</th></tr>";
		    
		    for (i in nom){ // Pour chaque département.
			   //console.log(nom[i]);
			    text = text + "<tr><td>"+nom[i]+"</td><td>"+adresse[i]+"</td><td>"+cp[i]+"</td><td>"+commune[i]+"</td><td>"+lien[i]+"</td></tr>"; 
		    }
		    //console.log(text);
		    var donnee_MDPH = document.getElementById("tab_MDPH");
		    donnee_MDPH.innerHTML=text; 
	
          })})
		
		result_MDPH;
  }
	
	

   //API MDPH
	var result_MDPH;
	fetch('https://api.opendata.onisep.fr/api/1.0/dataset/57e13aa4a3cee/search?size=300')
	  .then(function(response) {
	    response.json()
		.then(function(data) {
	    console.log('Request successful');
		result_MDPH=data;
		//api 'premise' si on veut sortir du fetch
		var tout_dep=[];
		for(i in result_MDPH.results){
			//console.log(result_MDPH.results[i]["departement"]);
			tout_dep.push(result_MDPH.results[i]["departement"]);
		}
		//console.log(tout_dep);
		//fonction pour supprimer les doublons des departements.
		const unique = (value, index, self) => {
			return self.indexOf(value) === index
		}
		const uniqueDep=tout_dep.filter(unique);
		console.log(uniqueDep);//liste unique avec les 101 dep francais
		
		uniqueDep.sort();//tri en ordre croissant la liste des departements
		
		var mesOptions = "";
		for(i in uniqueDep){
			mesOptions=mesOptions+"<option value='"+uniqueDep[i]+"'>"+uniqueDep[i]+"</option>";
			//console.log(uniqueDep[i]);
		} 
		var monDep = document.getElementById("dep");
		monDep.innerHTML = mesOptions;
		
			
		
	  })})
		
		result_MDPH;
		
		
	//API ULIS
	var result_ULIS;
	var region = "Occitanie" 
	fetch('https://api.opendata.onisep.fr/api/1.0/dataset/57e13d4faa63e/search?size=1000&facet.region=Occitanie')
	  .then(function(response) {
	    response.json()
		.then(function(data) {
	    console.log('ok'); 
	result_ULIS=data;
	
	var nom_ULIS = new Array;
	var adresse_ULIS = new Array;
	var commune_ULIS = new Array;
	var CodePostal_ULIS = new Array;
	
		//Récupère le résultat 
	for (i in result_ULIS){
		if (result_ULIS.results[i]["type_handicap_principal"] == handicap_ulis && result_ULIS.results[i]["departement"] == dep){
		nom_ULIS.push(result_ULIS.results[i]["nom"]);
		adresse_ULIS.push(result_ULIS.results[i]["adresse"]);
		commune_ULIS.push(result_ULIS.results[i]["commune"]);
		CodePostal_ULIS.push(result_ULIS.results[i]["cp"]);
		
		}
	};
	
	// Création du tableau ULIS 
	var tableau = "";
	var titre = "<table> <tr> <th>Nom</th> <th>Adresse</th> <th>Code Postal</th> <th>Commune</th> </tr>";
	tableau += titre;
		    
	for (i in nom_ULIS){ 
		var ligne = "<tr> <td>"+nom_ULIS[i]+"</td> <td>"+adresse_ULIS[i]+"</td> <td>"+CodePostal_ULIS[i]+"</td> <td>"+commune_ULIS[i]+"</td> </tr>";
		tableau += ligne; 
	}
	tableau += "</table>";
	
	// Ajout dans le HTML 
	var tableau_ULIS = document.getElementById("tableau_ULIS");
	tableau_ULIS.innerHTML=tableau; 
	
	
	  })})
	result_ULIS;	
	
	</script>
	
</html>
