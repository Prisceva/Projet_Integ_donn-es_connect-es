<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<title>PROJET API</title>
	</head>
	<body>

		<p>test final </p>
	
		<select id="dep">
		</select>
		
	<SELECT name="handicap" id="handicap"> 
	<OPTION VALUE="visuel">Visuel</OPTION> 
	<OPTION VALUE="cognitif">Cognitif/Intellectuel</OPTION> 
	<OPTION VALUE="auditif">Auditif</OPTION> 
	<OPTION VALUE="moteur">Moteur</OPTION> 
	<OPTION VALUE="autiste">Autiste</OPTION> 
	<OPTION VALUE="sante">Santé</OPTION>
	<OPTION VALUE="apprentissages">Apprentissage</OPTION>
	<OPTION VALUE="multiple">Multiple</OPTION>
	</SELECT>
		
		<button type="button" onclick="retrouverVarDep()">rechercher</button>
				
    <table id = "tab_MDPH">
    </table>
    
    <table id="tab_asso">
	</table>
	
	<table id = "tableau_ULIS">
    </table>
		
	</body>
	<script type="text/javascript" src="RequeteAsso.js"></script>
	
	<script>

	function retrouverVarDep(){
	
	console.log(document.getElementById("handicap").value);
	console.log(document.getElementById("dep").value);
	
    var dep= document.getElementById("dep").value;
    var handicap = document.getElementById("handicap").value;

    var handicap_asso=""
	var handicap_ulis=""

	if (handicap =="visuel") {
		handicap_asso="handicap visuel";
		handicap_ulis="TFV : troubles de la fonction visuelle";
		}; 
		
	if (handicap == "cognitif") {
		handicap_asso="troubles cognitifs / déficience intellectuelle";
		handicap_ulis="TFC : troubles des fonctions cognitives ou mentales";
	};

	if (handicap == "auditif") {
		handicap_asso="handicap auditif";
		handicap_ulis="TFA : troubles de la fonction auditive";
	} ;

	if (handicap == "moteur") {
		handicap_asso="handicap moteur";
		handicap_ulis="TFM : troubles des fonctions motrices";
	};

	if (handicap == "autiste") {
		handicap_asso="troubles du développement (autisme)";
		handicap_ulis="TED : troubles envahissants du développement (dont l'autisme)";
	};

	if (handicap == "sante") {
		handicap_asso="troubles de la santé";
		handicap_ulis="";
	};

	if (handicap == "apprentissages") {
		handicap_asso="troubles des apprentissages";
		handicap_ulis="troubles spécifiques du langage et des apprentissages";
	};

	if (handicap == "multiple") {
		handicap_asso="tous types de handicaps";
		handicap_ulis="TMA : troubles multiples associés";
	}; 

	if (handicap== "") {
		console.log("pas de trouble")
	};


    //API MDPH
	var result_MDPH;
	fetch('https://api.opendata.onisep.fr/api/1.0/dataset/57e13aa4a3cee/search?size=300')
	  .then(function(response) {
	    response.json()
		.then(function(data) {
	    console.log('Request successful');
		    result_MDPH=data;
		    var nom= new Array;
		    var adresse= new Array;
		    var commune= new Array;
		    var cp= new Array;
		    var lien= new Array;
		    
		    for (i=0;i<result_MDPH.results.length;i++){
			    if (result_MDPH.results[i]["departement"] == dep) {
				    nom.push(result_MDPH.results[i]["nom"]);
				    adresse.push(result_MDPH.results[i]["adresse"]);
				    commune.push(result_MDPH.results[i]["commune"]);
				    cp.push(result_MDPH.results[i]["cp"]);
				    lien.push(result_MDPH.results[i]["lien_site_onisepfr"])
			    }
		    };
		    
		    var text="";
		    // On défini les en tetes :
		    text = text + "<tr><th>Nom</th><th>Adresse</th><th>Code Postal</th><th>Commune</th><th>Site web</th></tr>";
		    
		    for (i in nom){ // Pour chaque département.
			   //console.log(nom[i]);
			    text = text + "<tr><td>"+nom[i]+"</td><td>"+adresse[i]+"</td><td>"+cp[i]+"</td><td>"+commune[i]+"</td><td>"+lien[i]+"</td></tr>"; 
		    }
		    //console.log(text);
		    var donnee_MDPH = document.getElementById("tab_MDPH");
		    donnee_MDPH.innerHTML=text; 
	
          })})
		
		result_MDPH;
		
		BuildResultAsso("tab_asso",handicap_asso,dep);
		
		//API REGION
		  //recupere le code region celon le departement.
		  console.log(dep.substring(0, 2));//on prend le code departement juste les deux chiffre donc on faite une sous chaine de carateres
		  var dep_temporaire=dep.substring(0, 2);//variable dep avec deux chiffre pour recherche
		  var result_Region;
		  fetch('https://geo.api.gouv.fr/departements/'+dep_temporaire+'?fields=nom,code,codeRegion,region')
		  .then(function(response) {//on recupere le code region selon son code departement
			response.json()
			.then(function(data) {
				console.log('Request successful REGION');
				result_Region=data;
				console.log(result_Region.codeRegion);//le code region renvoyer du departement (correspond a ceux de la API ULIS)
				console.log(result_Region.region["nom"]);
				var nomRegion=result_Region.region["nom"];
				/*
					API ULIS : RECHERCHE etablissement
				*/
				var result_ULIS;
				fetch('https://api.opendata.onisep.fr/api/1.0/dataset/57e13d4faa63e/search?size=1000&facet.region='+nomRegion)
				.then(function(response) {
					response.json()
					.then(function(data) {
						console.log('Request successful ULIS'); 
						result_ULIS=data;
						console.log(nomRegion);
						
			//Définition des variables 			
				var nom_ULIS = new Array;
				var adresse_ULIS = new Array;
				var commune_ULIS = new Array;
				var CodePostal_ULIS = new Array;
				var typeEtablissement_ULIS = new Array;	
				var titre = "";
				var controle = true;
	
			//Récupère le résultat 
			for (i = 0; i < result_ULIS.results.length; i++){
				if (result_ULIS.results[i]["type_handicap_principal"] == handicap_ulis && result_ULIS.results[i]["departement"] == dep){
					nom_ULIS.push(result_ULIS.results[i]["nom"]);
					adresse_ULIS.push(result_ULIS.results[i]["adresse"]);
					commune_ULIS.push(result_ULIS.results[i]["commune"]);
					typeEtablissement_ULIS.push(result_ULIS.results[i]["type_detablissement"]);
					CodePostal_ULIS.push(result_ULIS.results[i]["cp"]);
				}		
			}	
		
			//Création du tableau 
			var tableau = "";
			titre += "ÉTABLISSEMENT DANS VOTRE DÉPARTEMENT "; 
			tableau +=titre;
			tableau += "<tr><th>Nom</th><th>Type d'établissement</th><th>Adresse</th><th>Commune</th><th>Code Postal</th></tr>";
		
			for (i = 0; i < nom_ULIS.length; i++){
			tableau += "<tr><td>"+nom_ULIS[i]+"</td><td>"+typeEtablissement_ULIS[i]+"</td><td>"+adresse_ULIS[i]+"</td><td>"+commune_ULIS[i]+"</td><td>"+CodePostal_ULIS[i]+"</td></tr>";
			}
		
			// Ajustement HTML
			var tableauHTML = document.getElementById("tableau_ULIS");
			tableauHTML.innerHTML=tableau;
		
				
		})})
		result_ULIS;
		
		})})
		result_Region;
		
		
		
  }
	
	

   //API MDPH
	var result_MDPH;
	fetch('https://api.opendata.onisep.fr/api/1.0/dataset/57e13aa4a3cee/search?size=300')
	  .then(function(response) {
	    response.json()
		.then(function(data) {
	    console.log('Request successful');
		result_MDPH=data;
		//api 'premise' si on veut sortir du fetch
		var tout_dep=[];
		for(i in result_MDPH.results){
			//console.log(result_MDPH.results[i]["departement"]);
			tout_dep.push(result_MDPH.results[i]["departement"]);
		}
		//console.log(tout_dep);
		//fonction pour supprimer les doublons des departements.
		const unique = (value, index, self) => {
			return self.indexOf(value) === index
		}
		const uniqueDep=tout_dep.filter(unique);
		console.log(uniqueDep);//liste unique avec les 101 dep francais
		
		uniqueDep.sort();//tri en ordre croissant la liste des departements
		
		var mesOptions = "";
		for(i in uniqueDep){
			mesOptions=mesOptions+"<option value='"+uniqueDep[i]+"'>"+uniqueDep[i]+"</option>";
			//console.log(uniqueDep[i]);
		} 
		var monDep = document.getElementById("dep");
		monDep.innerHTML = mesOptions;
		
			
		
	  })})
		
		result_MDPH;
		
			
	</script>
	
</html>
